 <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Know Thy Self</title>


<link rel="stylesheet" href="signInLogIn.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script src="http://ft2json.appspot.com/api/ft2json.js" type="text/javascript"></script>
<script src="accessFT.js" type="text/javascript"></script>
<script type="text/javascript">
	
	$(document).on("ready",function(){

		//set-up for initial page view
		$('#welcome1').hide();
		$('#welcome2').hide();
		$('#access').hide();

		//formating for links on mouse hover
		$('a').hover(
			function(){$('a').css({'color': 'red'});},
			function(){$('a').css({'color': 'black'});}
			);

		//gets window size for formating divs
		$(function(){
    		$('#blur') .css({'height': (($(window).height()))});
    		$('#access, #get-account') .css({'height': (($(window).height())*.75)});
		});
		
		//gets window size on resize for formating divs
		$(window).resize(function(){
		   $('#blur') .css({'height': (($(window).height()))});
		   $('#access, #get-account') .css({'height': (($(window).height())*.75)});
		});

		//switches from sign-up page to sign-in
		$('#goToSignIn').on('click', function(){
			$('#get-account').hide();
			$('#access').show();
			$('#warning').html("");
		});

		//switches from sign-in page to sign-up
		$('#goToSignUp').on('click', function(){
			$('#access').hide();
			$('#get-account').show();
			$('#tryAgain').html("");
		});

		//Checks username against FT using python proxy
		$('#sign-up').on('submit' ,function(){
			
			console.log('get-account form submitted');
			
			//var email_val = /^.+@\w+..+$/;
			var userName = $('#userName').val();
			userName = userName + "@ischool.berkeley.edu";

			//if (email.search(email_val) !== -1) {

				$.post('http://people.ischool.berkeley.edu/~ruidai/cgi-bin/proxy.py?callback=?', {action: 'get_token', email: userName}, function(data) {

					data = trim(data);
					checkEmail(data);

				});
			/*} else {

				$('#warning').html('*Invalid email format, try again');
				console.log('not a correct email');
			}*/
			
			return false;
		});

		//Eliminates invisible characters 
		function trim(stringToTrim) {
     		  return stringToTrim.replace(/^\s+|\s+$/g,"");
		}

		//Evaluates states sent from Python proxy and modifies html of login elements accordingly
		function checkEmail (proxyRes){

			//console.log(proxyRes);

			if (proxyRes === "NOT_FOUND"){
				$('#warning').html('*Sorry, sign-up only available for UC Berkeley MIMS 2013 and 2014 students');

			} else if (proxyRes == 'SOMETHING_WRONG'){
				console.log('Error somewhere in proxy server processing');

			} else if (proxyRes == 'GENERATED'){

				$('#get-account').hide();
				$('#welcome1, #access').show();

			} else if (proxyRes == 'RESENT'){

				$('#get-account').hide();
				$('#welcome2, #access').show();

			} else {

				console.log('ooops...something is terribly wrong! debug time : (');

			}

		}

		//Checks user name and token against fusion table using python proxy.  Grants access 
		//or not based on value passed back.
		$('#log-in').on('submit', function(){

			console.log('log-in form submitted');

			var email_complete = $('#user').val()+"@ischool.berkeley.edu";

			$.post('http://people.ischool.berkeley.edu/~ruidai/cgi-bin/proxy.py?callback=?', {action: 'verify_token', email: email_complete, token: $('#token').val()},
				function(data) {

					data = trim(data);
					if (data == "True"){

						$('#login-container').fadeOut('slow');
						$('#blur').fadeOut('slow');

					} else{

						$('#tryAgain').html('*Incorrect login information.  Please try again.');

					}
			});

			return false;

		});

	});	


</script>
</head>

<body>


<div id ="blur">
</div>

<div id ="login-container">
	<div id="get-account">
		<h2>Having doubts?<h2>
		<h1>Sign up to Know Thy Self!</h1> 
		<p></p>
		<form id ="sign-up" method = "post">
			<label>Enter your ischool user name: </label><input type='text' id = 'userName'/> 
			<input type='submit' value ='Sign me up!'/><br>
			<label class = "warning" id = 'warning'></label>
		</form> 
		<p>Already signed-up? <a id="goToSignIn"> Click here to sign in </a><p>

	</div>

	<div id="access">
		<div id="welcome1">
			<h1>Welcome!</h1>
			<p>To get started, check your email for your personal token and enter it below along with your ischool email.</p>
		</div>

		<div id="welcome2">
			<h1>Welcome back!</h1>
			<p>Your token has been resent to your email.  Go grab it if you forgot or enter it below along with your ischool email.</p>
		</div>

		<h2>Sign in to Know Thy Self!</h2>
		<form id = "log-in" method = "post">
			<table>
				<tr>
					<td><label>User Name: </label></td>
					<td><input type = 'text' id = 'user'/></td>
				</tr>
				<tr>
					<td><label>Token: </label></td>
					<td><input type = 'text' id = 'token'/></td>
					<td><input type = 'submit' value = 'Sign in'/></td>
				</tr>
			</table>
			<label class = "warning" id = 'tryAgain'></label> 
		</form>
		<p>Don't have a token? <a id ="goToSignUp">Click here to sign-up</a></p>
	</div>
</div>

<div id ="output">
</div>

</body>

</html>



